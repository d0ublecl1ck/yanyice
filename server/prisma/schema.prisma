generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

enum ModuleType {
  liuyao
  bazi
}

enum VerifiedStatus {
  unverified
  accurate
  inaccurate
  partial
}

enum AiVendor {
  zhipu
  openai
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  aiVendor     AiVendor @default(zhipu)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  customers      Customer[]
  customerEvents CustomerEvent[]
  records        ConsultationRecord[]
  rules          Rule[]
  quotes         Quote[]
  aiConfigs      UserAiConfig[]
  aiCredentials  UserAiCredential[]
}

model Customer {
  id           String   @id @default(cuid())
  userId       String
  name         String
  gender       String
  birthDate    String?
  birthTime    String?
  phone        String?
  tags         Json
  notes        String
  customFields Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user    User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  events  CustomerEvent[]

  @@index([userId])
}

model CustomerEvent {
  id          String   @id @default(cuid())
  userId      String
  customerId  String
  occurredAt  DateTime
  description String
  tags        Json
  createdAt   DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([customerId])
}

model ConsultationRecord {
  id             String         @id @default(cuid())
  userId         String
  module         ModuleType     @default(liuyao)
  customerId     String?
  customerName   String?
  subject        String
  notes          String
  tagsJson       String         @default("[]")
  liuyaoDataJson String?
  baziDataJson   String?
  verifiedStatus VerifiedStatus @default(unverified)
  verifiedNotes  String         @default("")
  pinnedAt       DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, module, createdAt])
  @@index([userId, module, pinnedAt])
}

model Rule {
  id        String     @id @default(cuid())
  userId    String
  seedKey   String?
  module    ModuleType @default(liuyao)
  name      String
  enabled   Boolean    @default(true)
  condition String
  message   String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, module])
  @@unique([userId, seedKey])
}

model UserAiConfig {
  id        String   @id @default(cuid())
  userId    String
  vendor    AiVendor @default(zhipu)
  model     String   @default("")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, vendor])
}

model UserAiCredential {
  id           String   @id @default(cuid())
  userId       String
  vendor       AiVendor @default(zhipu)
  apiKeyCipher String
  apiKeyIv     String
  apiKeyTag    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, vendor])
}

model Quote {
  id        String   @id @default(cuid())
  userId    String
  seedKey   String?
  text      String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@unique([userId, seedKey])
}
